<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
"http://www.w3.org/TR/html4/strict.dtd">
<!-- vim: set expandtab ts=4 sw=4: -->
<!-- 
        Weather Thing

        This is a web thing to visualize weather data.

        If you're interested, the source is at

        http://github.com/oldpatricka/Weather-Thing
-->
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>
triplefox.com
</title>
<style type="text/css">

</style>

<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/processing.js"></script>

</head>
<body>
    <center>
<script>

    var tzOffsetInMs = (new Date()).getTimezoneOffset() * 60 * 1000;

    var p = {};

    var wview = {};

    wview.setup = function() {
        p.size(800,600);
        p.background(255);
        p.noLoop();
    }

    wview.draw = function() {
        $.getJSON("/weatherdata?&station=118",
        function(data){

                times = []
                for (key in data) {

                    times.push(String(key));
                }

                times.sort();
                smallest = times[0];

                var lastt = 0;
                var lasttemp = (data[times[0]]) * (p.height / 60);
                lastdate = (new Date(times[0]*1000 + tzOffsetInMs)).getDate();

                for (k=1; k < times.length; k++) {
                    p.stroke(0);
    
                    console.log(p.width + " " + times.length);

                    var t = (times[k] - times[0]) * (p.width / (times[times.length - 1] - times[0]));
                    var temp = (30 - data[times[k]]) * (p.height / 60);
                    p.line(lastt, lasttemp, t, temp);

                    // Calculate date tics
                    thisdate = (new Date(times[k]*1000 + tzOffsetInMs)).getDate();
                    if (thisdate != lastdate) {
                        console.log(thisdate + " " + lastdate);
                        p.stroke(0, 25);
                        p.line(t, 0, t, p.height);
                        lastdate = thisdate;
                    }
                    
                    //lastrealtime = realtime;
                    lastt = t;
                    lasttemp = temp
                }

                // Draw legend markers
                p.stroke(0, 255/2);
                p.line(0, p.height/2, p.width, p.height/2);
                p.stroke(0, 25);
                p.line(0, p.height/4, p.width, p.height/4);
                p.line(0, 0, p.width, 0);
            });
        p.exit();
    }

    $(document).ready(function() {


        p = Processing("weather");
        p.setup = wview.setup;
        p.draw = wview.draw;
        p.init();
    });


    </script><canvas id="weather" width="800" height="600"></canvas></center>
</body>
</html>
