<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
"http://www.w3.org/TR/html4/strict.dtd">
<!-- vim: set expandtab ts=4 sw=4: -->
<!-- 
        Weather Thing

        This is a web thing to visualize weather data.

        If you're interested, the source is at

        http://github.com/oldpatricka/Weather-Thing
-->
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>
Weather Thing
</title>
<style type="text/css">

</style>

<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/processing.js"></script>

</head>
<body>
    <center>
<script>

    var getUrlVars = function() {
        var map = {};
        var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
            map[key] = value;
        });
        return map;
    }

    var getData = function(fyear, fmonth, tyear, tmonth) {
        $.getJSON("/weatherdata?&station=118&fyear=" + fyear + "&fmonth=" + fmonth + "&tyear=" + tyear + "&tmonth=" + tmonth,
        function(weatherData){
            data = weatherData;
            wview.draw();
        });
    }

    var data = {};
    var urlVars = getUrlVars();
    var tzOffsetInMs = (new Date()).getTimezoneOffset() * 60 * 1000;
    var p = {};
    var wview = {};
    var from, to;

    // Date and Time helpers
    var today = new Date();
    var thisYear = today.getFullYear();
    var thisMonth = today.getMonth();
    var thisDay = today.getDate();

    
    if (urlVars["from"]) {
        from = new Date(urlVars["from"]*1000);
    }
    else {
        from = new Date();
        from = new Date(from.setDate(from.getDate() - 7))
    }

    if (urlVars["to"]) {
        to = new Date(urlVars["to"]);
    }
    else {
        to = today;
    }


    wview.setup = function() {
        p.size(800,600);
        p.noLoop();
    }

    wview.draw = function() {
        //Set things up
        p.fill(0);
        p.deja = p.loadFont("DejaVuSerif.svg");
        p.textFont(p.deja, 12);
        p.background(255);
        p.fill(255);
        p.rect(0, 0, p.width, p.height);
        p.fill(0);

        // index and sort dates
        var times = []
        for (var key in data) {
            if (key * 1000 >= from.getTime() && key * 1000 <= to.getTime()) {
                times.push(String(key));
            }
        }

        times.sort();
        var smallest = times[0];


        //Draw plot
        var lastt = 0;
        var lasttemp = (data[times[0]]) * (p.height / 60);
        var lastdate = (new Date(times[0]*1000 + tzOffsetInMs)).getDate();

        for (k=1; k < times.length; k++) {
            //console.log(new Date(times[k] * 1000));
            p.stroke(0);

            var t = (times[k] - times[0]) * (p.width / (times[times.length - 1] - times[0]));
            var temp = (30 - data[times[k]]) * (p.height / 60);
            p.line(lastt, lasttemp, t, temp);

            // Calculate date tics
            
            var thisdate = (new Date(times[k]*1000 + tzOffsetInMs)).getDate();
            if (thisdate != lastdate) {
                p.stroke(0, 25);
                p.line(t, 0, t, p.height);
                p.text(String(thisdate), t, p.height/2 );

                lastdate = thisdate;
            }

            lastt = t;
            lasttemp = temp
        }

        // Draw legend markers
        p.stroke(0, 255/2);
        p.line(0, p.height/2, p.width, p.height/2);
        p.stroke(0, 25);
        p.line(0, p.height/4, p.width, p.height/4);
        p.line(0, 0, p.width, 0);

        p.exit();
    }

    

    $(document).ready(function() {

        p = Processing("weather");
        p.setup = wview.setup;
        p.draw = wview.draw;
        p.init();
        
        getData(from.getFullYear(), from.getMonth()+1, to.getFullYear(), to.getMonth()+1 );
        p.draw();

        // Controls

        $("#fewerdays").click(function() {

            from.setDate(from.getDate() + 1);
            p.draw()
            return false;
        });

        $("#moredays").click(function() {

            from.setDate(from.getDate() - 1);
            p.draw()
            return false;
        });
    });
    </script>
    
    <a href="#" id="fewerdays">-</a> <a href="#" id="moredays">+</a><br>
    <canvas id="weather" width="800" height="600"></canvas></center>
</body>
</html>
